<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bayesian Instrumental Variable analysis for Continuous Outcomes • biva</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian Instrumental Variable analysis for Continuous Outcomes">
<meta property="og:description" content="biva">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biva</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Gaussian.html">Bayesian Instrumental Variable analysis for Continuous Outcomes</a>
    </li>
    <li>
      <a href="../articles/logit.html">Bayesian Instrumental Variable analysis for Binary Outcomes</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bayesian Instrumental Variable analysis for
Continuous Outcomes</h1>
                        <h4 data-toc-skip class="author">Yichi
Zhang</h4>
            
      
      
      <div class="hidden name"><code>Gaussian.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<div class="section level3">
<h3 id="what-is-the-challenge">What is the challenge?<a class="anchor" aria-label="anchor" href="#what-is-the-challenge"></a>
</h3>
<p>Randomized experiments are the gold standard for impact measurement.
However, it is common that the treatment of interest can not be
enforced, like the usage of a feature, or participation in a program.
Instead, nudges, invites, recommendations, or encouragements are
randomly assigned to induce the treatment of interest. This type of
experiment design unlocks opportunities to measure the impact of
numerous unenforceable treatments, but introduces a noncompliance
problem: whether units adopt the treatment assigned to them is not
guaranteed and subject to unobserved confounding bias.</p>
<p>Suppose the assignment is <span class="math inline">\(Z\)</span>
(<span class="math inline">\(Z = 1\)</span> if nudged, <span class="math inline">\(0\)</span> otherwise), the potential treatment
adoption is <span class="math inline">\(D(Z=z) = D(z)\)</span> (<span class="math inline">\(D = 1\)</span> if adopted, <span class="math inline">\(0\)</span> otherwise), and the potential outcome
is <span class="math inline">\(Y(Z=z) = Y(z)\)</span>. There are four
principal strata in this setting:</p>
<ul>
<li>Compliers: <span class="math inline">\(D(1) = 1\)</span>, <span class="math inline">\(D(0) = 0\)</span>, units who adopt the treatment
when nudged, and do not adopt otherwise.</li>
<li>Never-takers: <span class="math inline">\(D(1) = D(0) = 0\)</span>,
units who never adopt the treatment regardless of nudges.</li>
<li>Always-takers: <span class="math inline">\(D(1) = D(0) = 1\)</span>,
units who always adopt the treatment regardless of nudges.</li>
<li>Defiers: <span class="math inline">\(D(1) = 0\)</span>, <span class="math inline">\(D(0) = 1\)</span>, units who do the opposite of
what they are nudged to do.</li>
</ul>
<p>Compliers and defiers are the subgroups for which the impact of the
treatment is well-defined and provide us with information measuring it.
It is up to the study design and the collected data that some of the
subpopulations may be assumed to nonexist. For example, it is common to
assume no defiers. In this case, only compliers will be the target
population for impact measurement.</p>
</div>
<div class="section level3">
<h3 id="what-does-not-work">What does not work?<a class="anchor" aria-label="anchor" href="#what-does-not-work"></a>
</h3>
<p>This noncompliance setting with unobserved confounders deems some
traditional approaches biased or irrelevant.</p>
<ul>
<li>The Intention to Treat (ITT) analysis contrasts the average outcomes
by treatment assignment, ignoring the actual treatment adoption. It
estimates the impact of the nudge, not the treatment feature.</li>
</ul>
<p><span class="math display">\[
\hat{ITT}
= \hat{E}[Y_i(1) - Y_i(0)]
= \hat{E}[Y_i|Z_i=1] - \hat{E}[Y_i|Z_i=0]
= \frac{\sum_{i=1}^n Y_i Z_i}{\sum_{i=1}^n Z_i}
- \frac{\sum_{i=1}^n Y_i (1-Z_i)}{\sum_{i=1}^n (1-Z_i)}.
\]</span></p>
<ul>
<li>The per-protocol analysis contrasts the average outcomes by
treatment assignment, discarding noncompliant units, so treatment
assignment is the same as treatment adopted. It compares two different
populations. The treatment group is the mixture of compliers and
always-takers, and the control group is the mixture of compliers and
never-takers. It can hardly be interpreted as any causal impact since
the target population is unclear.</li>
</ul>
<p><span class="math display">\[
\hat{PP}
= \hat{E}[Y_i|Z_i=1, D_i = 1] - \hat{E}[Y_i|Z_i=0, D_i = 0]
= \frac{\sum_{i=1}^n Y_i Z_i D_i}{\sum_{i=1}^n Z_i D_i}
- \frac{\sum_{i=1}^n Y_i (1-Z_i) (1-D_i)}{\sum_{i=1}^n (1-Z_i) (1-D_i)}.
\]</span></p>
<ul>
<li>The as-treated analysis contrasts the average outcomes by treatment
adopted, ignoring the treatment assignment. It also compares two
different mixtures of subpopulations. An OLS extension further includes
other observed covariates <span class="math inline">\(X\)</span>. It is
still biased because the treatment adopted is not random and confounded
by unobserved confounders.</li>
</ul>
<p><span class="math display">\[
\hat{AT}_1
= \hat{E}[Y_i|D_i = 1] - \hat{E}[Y_i|D_i = 0]
= \frac{\sum_{i=1}^n Y_i D_i}{\sum_{i=1}^n D_i}
- \frac{\sum_{i=1}^n Y_i (1-D_i)}{\sum_{i=1}^n (1-D_i)},
\]</span></p>
<p>or</p>
<p><span class="math display">\[
Y_i = \beta_0 + \beta_1 D_i + \beta_2 X_i + \epsilon_i,
\hat{AT}_2 = \hat{\beta}_1.
\]</span></p>
</div>
<div class="section level3">
<h3 id="what-works">What works?<a class="anchor" aria-label="anchor" href="#what-works"></a>
</h3>
<p>To address this prominent obstacle towards impact measurement, this
example employs Bayesian instrumental variable analysis (BIVA) for
continuous outcomes. The intuition of an IV approach is to find an
exogenous variable that affects the treatment, and the outcome only
through the treatment, so that the effect of the treatment on the
outcome, confounded by other unobserved variables, can be disentangled
through the “IV-treatment-outcome” pathway.</p>
<p>Aside from no defiers, the following assumptions are made about the
nudge to justify its qualification as an IV:</p>
<ul>
<li>Random assignment: The assigned nudge is random.</li>
<li>Nonzero effect on the treatment: The assigned nudge has a nonzero
impact on the treatment adopted.</li>
<li>Exclusion restriction (ER): The assigned nudge does not directly
affect the outcome if not through the treatment adopted.</li>
</ul>
<p>The first assumption holds by design. The second assumption could be
tested. The third assumption is untestable but it is possible to relax
the assumption as a sensitivity analysis in a Bayesian approach.</p>
<p>The implications of these assumptions are:</p>
<ul>
<li>The effect of the nudge on the adopted treatment and the outcome can
be measured.</li>
<li>The proportion of compliers is nonzero.</li>
<li>The effect of the nudge on the outcome is zero among always-takers
and never-takers. The effect of the nudge on the outcome is interpreted
as the impact of the treatment feature among compliers.</li>
</ul>
<p>There are two types of methods that execute the IV analysis. They
both attempt to recover a local effect of the treatment among compliers
called the complier average causal effect (CACE) but with different
granularity. The first type of method is a global approach that does not
seek to model the individual membership to the principal strata or the
outcome by strata. They estimate the proportion of compliers, which
dilutes the CACE of the treatment to be the ITT effect of the nudge. In
other words, the proportion of compliers is the variation in the
treatment adoption explained by the nudge, that multiplies the effect of
the treatment on the outcome among compliers to be the variation in the
outcome explained by the nudge. Representative methods in this category
include the two-stage least squares (2SLS) and the frequentist moments
estimate by principal stratification. They intend to recover the
following quantity:</p>
<p><span class="math display">\[
\hat{CACE_1} = \hat{E}_1[Y_i(1) - Y_i(0)|D_i(1) = 1, D_i(0) = 0]
= \frac{\hat{E}[Y_i|Z_i=1] - \hat{E}[Y_i|Z_i=0]}
{\hat{E}[D_i|Z_i=1] - \hat{E}[D_i|Z_i=0]}.
\]</span></p>
<p>The second type of method imposes models to the principal strata and
outcomes by each strata-nudge combination. Within each strata, the
uptake pattern of the treatment is deterministic and homogenous, so the
confounded relationship between the treatment adoption and the outcome
is fixed and disentangled. The nudge will fully explain the variation in
the treatment adoption within each strata. The marginal variation of the
treatment adoption explained by the nudge, i.e, the proportion of
compliers, stems from each unit’s probability of being a complier by the
strata membership model. The model parameters are jointly estimated by a
frequentist maximum likelihood approach or a Bayesian approach. The
likelihood looks like the following:</p>
<p><span class="math display">\[
\prod_{i: Z_i = 0, D_i = 0} (\pi_{i,c} f_{i,c0} + \pi_{i,n} f_{i,n0})
\prod_{i: Z_i = 1, D_i = 1} (\pi_{i,c} f_{i,c1} + \pi_{i,a} f_{i,a1})
\prod_{i: Z_i = 0, D_i = 1} \pi_{i,a} f_{i,a0}
\prod_{i: Z_i = 1, D_i = 0} \pi_{i,n} f_{i,n1},
\]</span></p>
<p>where <span class="math inline">\(c\)</span> stands for compliers,
<span class="math inline">\(a\)</span> for always-takers, <span class="math inline">\(n\)</span> for never-takers, <span class="math inline">\(\pi_{i,g}\)</span> is the probability of unit
<span class="math inline">\(i\)</span> being in strata <span class="math inline">\(g\)</span>, and <span class="math inline">\(f_{i,gz}\)</span> is the outcome model for unit
<span class="math inline">\(i\)</span> in strata <span class="math inline">\(g\)</span> assigned to treatment status <span class="math inline">\(z\)</span>. Exclusion restriction is equivalent to
assuming <span class="math inline">\(f_{i,a0} = f_{i,a1}\)</span> and
<span class="math inline">\(f_{i,n0} = f_{i,n1}\)</span>. The CACE of
the treatment is recovered by the following quantity:</p>
<p><span class="math display">\[
\hat{CACE_2} = \hat{E}_2[Y_i(1) - Y_i(0)|D_i(1) = 1, D_i(0) = 0]
= \frac{\sum_{i = 1}^{n} \hat{\pi}_{i,c} (\hat{f}_{i,c1} -
\hat{f}_{i,c0})}
{\sum_{i = 1} ^ {n} \hat{\pi}_{i,c}}
\]</span></p>
<p>The BIVA approach we implement here belongs to the second type, and
multiplies priors of model parameters to the above likelihood to get the
posterior of the parameters including the CACE.</p>
</div>
<div class="section level3">
<h3 id="why-biva">Why BIVA?<a class="anchor" aria-label="anchor" href="#why-biva"></a>
</h3>
<p>Modeling IV in a Bayesian way allows for business leaders to more
directly apply the results of the analysis to the decisions they are
trying to make. It also allows the analysts (and leaders) to not be
bound to simply identifying whether the null hypothesis is rejected or
not - there is more flexibility in the statements that can be made,
which is particularly useful when the size of the data is small.</p>
<p>Below we demonstrate the overall workflow of the BIVA approach.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">biva</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="demonstration-1-one-side-noncompliance">Demonstration 1: one-side noncompliance<a class="anchor" aria-label="anchor" href="#demonstration-1-one-side-noncompliance"></a>
</h2>
<div class="section level3">
<h3 id="data-simulation">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation"></a>
</h3>
<p>First, we simulate some data from a hypothetical randomized
experiment with noncompliance. Those assigned to the treatment group can
decide to use a feature or not. Those assigned to the control group will
not have access to the feature. In other words, we have one-side
noncompliance where the assigned treated units can opt out but the
assigned control stay control.</p>
<p>Therefore, there are only 2 principal strata: compliers and
never-takers.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1997</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span></span>
<span><span class="co"># Covariates</span></span>
<span><span class="co"># X (continuous, observed)</span></span>
<span><span class="co"># U (binary, unobserved)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## True memberships of principal strata (1:c, 0:nt): S-model depends only on U</span></span>
<span><span class="va">true.PS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U1.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">U0.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">num.U1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U1.ind</span><span class="op">)</span></span>
<span><span class="va">num.U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U0.ind</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U1.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">num.U1</span>, <span class="fl">1</span>, <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U0.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">num.U0</span>, <span class="fl">1</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment assigned: half control &amp; half treatment</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment adopted: determined by principal strata and treatment assigned</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">c.trt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c.ctrl.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">nt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">num.c.trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.trt.ind</span><span class="op">)</span></span>
<span><span class="va">num.c.ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.ctrl.ind</span><span class="op">)</span></span>
<span><span class="va">num.nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nt.ind</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.c.trt</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate observed outcome: Y-model depend on X, U, D, and principal strata</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.ctrl</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.trt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5250</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.nt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">6000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, Z <span class="op">=</span> <span class="va">Z</span>, D <span class="op">=</span> <span class="va">D</span>, X <span class="op">=</span> <span class="va">X</span>, U <span class="op">=</span> <span class="va">U</span><span class="op">)</span></span></code></pre></div>
<p>The data-generating process specifies counterfactuals of the
compliance status and the outcome for each unit. Two exogenous baseline
covariates are generated. One is the observed continuous covariates X.
The other is the unobserved binary confounder U.</p>
<p>The membership to one of the two principal strata is determined by
the unobserved confounder U. A unit is a complier with probability 0.6
if U = 1, and with probability 0.3 if U = 0.</p>
<p>The outcome models are by different strata-nudge combinations. The
compliers may adopt the treatment or not depending on the assigned
nudge, and thus have two outcome models by treatment groups. The
never-takers will never adopt the treatment feature. We assume away the
direct effect of the nudge here so there is only one outcome model for
never-takers.</p>
<p>The three outcome models depend on both the observed X and the
unobserved U with the same slopes. The contrast between the intercepts
of the outcome models for compliers then becomes the CACE, which is 5250
- 5000 = 250.</p>
</div>
<div class="section level3">
<h3 id="ols-analysis">OLS analysis<a class="anchor" aria-label="anchor" href="#ols-analysis"></a>
</h3>
<p>To understand the caveats, we first fit an OLS model with the adopted
treatment D and the observed covariate X as in the aforementioned
as-treated analysis.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OLS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">OLS</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ D + X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -1045.4  -138.2   130.0   376.9   536.7 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  5614.35      37.43 149.997  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; D            -561.33      85.63  -6.555 4.76e-10 ***</span></span>
<span><span class="co">#&gt; X             100.93      33.74   2.992  0.00313 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 469.1 on 197 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.1922, Adjusted R-squared:  0.184 </span></span>
<span><span class="co">#&gt; F-statistic: 23.44 on 2 and 197 DF,  p-value: 7.371e-10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">OLS</span>, <span class="st">"D"</span><span class="op">)</span></span>
<span><span class="co">#&gt;       2.5 %    97.5 %</span></span>
<span><span class="co">#&gt; D -730.2007 -392.4531</span></span></code></pre></div>
<p>The OLS fit estimated an indisputably significant effect of the
feature to the opposite direction.</p>
<p>We next present how BIVA fixes this issue.</p>
</div>
<div class="section level3">
<h3 id="prior-predictive-checking">Prior predictive checking<a class="anchor" aria-label="anchor" href="#prior-predictive-checking"></a>
</h3>
<p>The BIVA model we specify will only include intercept and the
observed covariate X in predicting the strata and the outcome. We assume
exclusion restriction (ER = 1) and one-side noncompliance (side = 1).
Before fitting a BIVA model to the data, we visualize the encoded
assumptions about the data generating process by the specified
priors.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.225 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.072 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.297 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 3e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.211 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.071 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.282 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 3e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.214 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.071 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.285 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 3e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.219 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.071 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.29 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">plotPrior</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/priors_check_one_side-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The effect of the feature among compliers is negligible by priors.
The proportion of compliers and never-takers are half and half.</p>
</div>
<div class="section level3">
<h3 id="fitting-a-biva-model-to-the-data">Fitting a BIVA model to the data<a class="anchor" aria-label="anchor" href="#fitting-a-biva-model-to-the-data"></a>
</h3>
<p>Now we fit a BIVA model to the data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.217 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.089 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.306 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 3e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.202 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.074 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.276 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.233 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.07 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.303 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.2 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.074 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.274 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Fitting model to the data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.0002 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 12.439 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                1.284 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                13.723 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.000159 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.59 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 12.948 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                1.286 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                14.234 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.000175 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.75 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 13.689 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                1.25 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                14.939 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.000158 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.58 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 14.098 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                1.295 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                15.393 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Found more than one class "Rcpp_rstantools_model_logit" in cache; using the first, from namespace 'biva'</span></span>
<span><span class="co">#&gt; Also defined by 'im'</span></span>
<span><span class="co">#&gt; Found more than one class "Rcpp_rstantools_model_logit" in cache; using the first, from namespace 'biva'</span></span>
<span><span class="co">#&gt; Also defined by 'im'</span></span>
<span><span class="co">#&gt; All diagnostics look fine</span></span></code></pre></div>
<p>We can look at the trace plot of outcomes in each strata to see if
the chains mixed and converged. The three plots are the posterior draws
of the mean outcomes among the compliers assigned to control, the
compliers nudged to treatment, and the never-takers.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">tracePlot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/tracePlot_one_side-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The convergence and mixing look good.</p>
<p>A weak instrument test can be run to understand if there is concern
about the estimates due to a low proportion of compliers.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">weakIVTest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; The instrument is not considered weak, resulting in an estimated 41% of compliers in the population.</span></span></code></pre></div>
<p>The proportion of compliers is at a decent level to avoid potential
issues. More details are covered in a later example of weak
instrument.</p>
<p>We can use the following methods to summarize our findings:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Posterior distribution of the strata probability</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">strataProbEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 41% probability that the unit is a complier, and a 59% probability that the unit is a never-taker.</span></span>
<span><span class="co"># Posterior probability that CACE is greater than 200</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">calcProb</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that the probability that the effect is more than 200 is 76%.</span></span>
<span><span class="co"># Posterior median of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 224.8387</span></span>
<span><span class="co"># Posterior mean of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span>median <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 224.9999</span></span>
<span><span class="co"># 75% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 75% probability that the CACE is between 183.05 and 267.3.</span></span>
<span><span class="co"># 95% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 95% probability that the CACE is between 153.14 and 299.06.</span></span></code></pre></div>
<p>The posterior does a good job in recovering the direction and the
magnitude of the true impact among compliers. The statement about the
probability that the CACE is greater than 200, or with what probability
it falls in a certain range, are direct answers to the business question
of whether the feature is worth launching. This is prohibited by any
frequentist approach where the effect parameter is treated as nonrandom
and the confidence interval captures uncertainty in the sampling
distribution of data instead of in the parameter itself.</p>
<p>Users can also visualize how the data updates our knowledge about the
impact by comparing its posterior distribution with the prior. This can
be done by running the following methods. The output are interactive
html widgets. The outputs are hidden here.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">vizdraws</span><span class="op">(</span></span>
<span>  display_mode_name <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  break_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt; 200"</span>, <span class="st">"&gt; 200"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">lollipop</span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">200</span>, mediumText <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>The same procedures can be applied to a two-side noncompliance
setting, which usually happens when the feature has already been
launched or the assigned nudge can be leaked.</p>
</div>
</div>
<div class="section level2">
<h2 id="demonstration-2-two-side-noncompliance">Demonstration 2: two-side noncompliance<a class="anchor" aria-label="anchor" href="#demonstration-2-two-side-noncompliance"></a>
</h2>
<div class="section level3">
<h3 id="data-simulation-1">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation-1"></a>
</h3>
<p>We again simulate some data from a hypothetical randomized experiment
with noncompliance. Now we want to evaluate the impact of the feature
after it is launched. In this case, we have two-side noncompliance where
the assigned treated units can opt out and the assigned control can opt
in.</p>
<p>Therefore, there are 3 principal strata: compliers, never-takers, and
always-takers.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1997</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span></span>
<span><span class="co"># Covariates</span></span>
<span><span class="co"># X (continuous, observed)</span></span>
<span><span class="co"># U (binary, unobserved)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## True memberships of principal strata (1:c,2:nt,3:at): S-model depends only on U</span></span>
<span><span class="va">true.PS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U1.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">U0.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">num.U1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U1.ind</span><span class="op">)</span></span>
<span><span class="va">num.U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U0.ind</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U1.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U0.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment assigned: half control &amp; half treatment</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment received: determined by principal strata and treatment assigned</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">c.trt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c.ctrl.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">nt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">at.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">num.c.trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.trt.ind</span><span class="op">)</span></span>
<span><span class="va">num.c.ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.ctrl.ind</span><span class="op">)</span></span>
<span><span class="va">num.nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nt.ind</span><span class="op">)</span></span>
<span><span class="va">num.at</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">at.ind</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.at</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.c.trt</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate observed outcome: Y-model depend on X, U, D, and principal strata</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.ctrl</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.trt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5250</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.nt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">6000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.at</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">4500</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, Z <span class="op">=</span> <span class="va">Z</span>, D <span class="op">=</span> <span class="va">D</span>, X <span class="op">=</span> <span class="va">X</span>, U <span class="op">=</span> <span class="va">U</span><span class="op">)</span></span></code></pre></div>
<p>With always-takers, some changes are applied to the data-generating
process. For the strata model, when U = 1, a unit is a complier, a
never-taker, or an always-taker with probability 0.6, 0.3, and 0.1,
respectively. When U = 0, a unit is a complier, a never-taker, or an
always-taker with probability 0.4, 0.5, and 0.1, respectively.</p>
<p>The always-takers will always adopt the treatment feature. With
exclusion restriction, we add one outcome model for always-takers. The
remaining models are kept the same. The CACE of the feature is still
5250 - 5000 = 250.</p>
</div>
<div class="section level3">
<h3 id="ols-analysis-1">OLS analysis<a class="anchor" aria-label="anchor" href="#ols-analysis-1"></a>
</h3>
<p>We again fit an OLS model with the adopted treatment D and the
observed covariate X to see the caveats.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OLS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">OLS</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ D + X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -943.3 -502.1  171.7  410.2  553.0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  5530.36      43.13 128.216  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; D            -628.11      71.47  -8.788 7.49e-16 ***</span></span>
<span><span class="co">#&gt; X             108.69      34.45   3.154  0.00186 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 485 on 197 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.303,  Adjusted R-squared:  0.2959 </span></span>
<span><span class="co">#&gt; F-statistic: 42.81 on 2 and 197 DF,  p-value: 3.634e-16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">OLS</span>, <span class="st">"D"</span><span class="op">)</span></span>
<span><span class="co">#&gt;       2.5 %    97.5 %</span></span>
<span><span class="co">#&gt; D -769.0591 -487.1565</span></span></code></pre></div>
<p>It returns misleading significant results again.</p>
<p>We restart the BIVA workflow to fix this issue.</p>
</div>
<div class="section level3">
<h3 id="prior-predictive-checking-1">Prior predictive checking<a class="anchor" aria-label="anchor" href="#prior-predictive-checking-1"></a>
</h3>
<p>With two-side noncompliance, we set side = 2. The number of models in
specifying priors should be updated as well.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.302 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.084 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.386 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.285 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.092 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.377 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.296 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.088 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.384 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.309 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.086 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.395 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">plotPrior</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/priors_check_two_side-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The effect of the feature among compliers is negligible. The
proportions of compliers, never-takers, and always-takers are
similar.</p>
</div>
<div class="section level3">
<h3 id="fitting-a-biva-model-to-the-data-1">Fitting a BIVA model to the data<a class="anchor" aria-label="anchor" href="#fitting-a-biva-model-to-the-data-1"></a>
</h3>
<p>Now we fit a BIVA model to the data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.305 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.088 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.393 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.342 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.086 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.428 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.309 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.09 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.399 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.314 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.088 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.402 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Fitting model to the data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.0002 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 49.003 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                1.613 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                50.616 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.000225 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 2.25 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 19.432 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                1.614 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                21.046 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.000205 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 2.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 15.769 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                1.633 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                17.402 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.000196 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.96 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 15.827 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                1.643 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                17.47 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; All diagnostics look fine</span></span></code></pre></div>
<p>We look at the trace plot of outcomes in each strata to see if the
chains mixed and converged. The four plots are the posterior draws of
the mean outcomes among the compliers assigned to control, the compliers
nudged to treatment, the never-takers, and the always-takers.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">tracePlot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/tracePlot_two_side-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The convergence and mixing look good.</p>
<p>Now we run the weak instrument test.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">weakIVTest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; The instrument is not considered weak, resulting in an estimated 49% of compliers in the population.</span></span></code></pre></div>
<p>No serious concern about weak instrument is found.</p>
<p>We can use the following methods to summarize our findings:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Posterior distribution of the strata probability</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">strataProbEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 49% probability that the unit is a complier, a 42% probability that the unit is a never-taker, and a 10% probability that the unit is an always-taker.</span></span>
<span><span class="co"># Posterior probability that CACE is greater than 200</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">calcProb</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that the probability that the effect is more than 200 is 95%.</span></span>
<span><span class="co"># Posterior median of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 258.5116</span></span>
<span><span class="co"># Posterior mean of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span>median <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 257.8164</span></span>
<span><span class="co"># 75% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 75% probability that the CACE is between 218.17 and 296.33.</span></span>
<span><span class="co"># 95% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 95% probability that the CACE is between 188.98 and 324.36.</span></span></code></pre></div>
<p>The posterior returns conclusions close to the ground truth.</p>
<p>Visualizations of how the data updates our knowledge about the impact
by comparing its posterior distribution with the prior can be done by
running the following methods. We hide these outputs here.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">vizdraws</span><span class="op">(</span></span>
<span>  display_mode_name <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  break_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt; 200"</span>, <span class="st">"&gt; 200"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">lollipop</span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">200</span>, mediumText <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cautionary-note-1-poor-mixing-of-the-posterior-distribution">Cautionary note 1: poor mixing of the posterior distribution<a class="anchor" aria-label="anchor" href="#cautionary-note-1-poor-mixing-of-the-posterior-distribution"></a>
</h2>
<p>The BIVA model essentially fits a mixture likelihood model so it is
possible that it predicts incorrectly about the membership of some units
to the principal strata. Specifically, in two-side noncompliance, the
model may confuse a nudged complier with a always-taker (they both adopt
the treatment if assigned to the treatment), or confuse a control
complier with a never-taker (they both stay control if assigned to the
control). The phenomenon is less common in one-side noncompliance
because ruling out the always-takers helps with predicting the
compliers, and thus the never-takers. In either case, it is always a
good practice to see the trace plot of the posterior distribution
immediately after fitting the BIVA model as in the above workflow. It
helps with responsible choices of robust metrics for decision-making.
Below we show an example.</p>
<div class="section level3">
<h3 id="data-simulation-2">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation-2"></a>
</h3>
<p>We simulate some data from the same two-side noncompliance setting as
above with a different seed.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2001</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span></span>
<span><span class="co"># Covariates</span></span>
<span><span class="co"># X (continuous, observed)</span></span>
<span><span class="co"># U (binary, unobserved)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## True memberships of principal strata (1:c,2:nt,3:at): S-model depends only on U</span></span>
<span><span class="va">true.PS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U1.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">U0.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">num.U1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U1.ind</span><span class="op">)</span></span>
<span><span class="va">num.U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U0.ind</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U1.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U0.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment assigned: half control &amp; half treatment</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment received: determined by principal strata and treatment assigned</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">c.trt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c.ctrl.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">nt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">at.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">num.c.trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.trt.ind</span><span class="op">)</span></span>
<span><span class="va">num.c.ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.ctrl.ind</span><span class="op">)</span></span>
<span><span class="va">num.nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nt.ind</span><span class="op">)</span></span>
<span><span class="va">num.at</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">at.ind</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.at</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.c.trt</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate observed outcome: Y-model depend on X, U, D, and principal strata</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.ctrl</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.trt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5250</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.nt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">6000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.at</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">4500</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, Z <span class="op">=</span> <span class="va">Z</span>, D <span class="op">=</span> <span class="va">D</span>, X <span class="op">=</span> <span class="va">X</span>, U <span class="op">=</span> <span class="va">U</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-a-biva-model-to-the-data-2">Fitting a BIVA model to the data<a class="anchor" aria-label="anchor" href="#fitting-a-biva-model-to-the-data-2"></a>
</h3>
<p>The prior specifications stay the same so we skip to the step of
fitting a BIVA model to the data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 6e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.06 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.314 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.087 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.401 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.257 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.106 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.363 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.327 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.088 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.415 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.287 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.086 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.373 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Fitting model to the data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000202 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2.02 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 15.468 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                1.574 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                17.042 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.000192 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.92 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 20.382 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                1.597 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                21.979 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.000191 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.91 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 19.172 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                1.579 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                20.751 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.000191 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.91 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 18.872 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                1.578 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                20.45 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; All diagnostics look fine</span></span></code></pre></div>
<p>This is the key step of identifying the potential issue of poor
mixing.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">tracePlot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/tracePlot_two_side_poor_mixing-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The four plots are the posterior draws of the mean outcomes among the
compliers assigned to control, the compliers nudged to treatment, the
never-takers, and the always-takers. The poor mixing in the second and
the fourth plots warns us about the potential issue of confusing the
nudged compliers with the always-takers. We know from this simulation
example that the always-takers on average have lower outcomes than the
compliers so this explains the dark blue chain underestimating the
outcomes among nudged compliers and overestimating the outcomes among
always-takers. In this case, the CACE estimate will be underestimated as
well.</p>
<p>Before getting the test statistics, we run the weak instrument test
to see if the issue of poor mixing is due to a weak instrument.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">weakIVTest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; The instrument is not considered weak, resulting in an estimated 50% of compliers in the population.</span></span></code></pre></div>
<p>No weak instrument issue is detected.</p>
<p>More detailed findings are reported by the same methods. Compared to
the results from the above two-side example with good mixing, it
overestimates the proportion of never-takers. Both posterior mean and
median are underestimated. More uncertainty is reflected in the
posterior probability that the CACE is greater than 200. Wider credible
intervals are reported.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Posterior distribution of the strata probability</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">strataProbEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 50% probability that the unit is a complier, a 38% probability that the unit is a never-taker, and a 13% probability that the unit is an always-taker.</span></span>
<span><span class="co"># Posterior probability that CACE is greater than 200</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">calcProb</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that the probability that the effect is more than 200 is 81%.</span></span>
<span><span class="co"># Posterior median of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 227.0423</span></span>
<span><span class="co"># Posterior mean of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span>median <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 227.3359</span></span>
<span><span class="co"># 75% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 75% probability that the CACE is between 191.52 and 263.1.</span></span>
<span><span class="co"># 95% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 95% probability that the CACE is between 166.17 and 288.01.</span></span></code></pre></div>
<p>In real data analysis, without knowing the actual direction and
magnitude of the inaccurate estimation, it is better not to use the
posterior mean as the only reported point estimate. The posterior median
will be a more robust choice. Posterior probability and credible
intervals are faithful characterizations of the uncertainty relevant to
decision-making.</p>
<p>The issue of poor mixing can also be identified by the vizdraws
method. Users will see bimodal distribution of the posterior for the
CACE in the plot.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">vizdraws</span><span class="op">(</span></span>
<span>  display_mode_name <span class="op">=</span> <span class="cn">TRUE</span>, breaks <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  break_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt; 200"</span>, <span class="st">"&gt; 200"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cautionary-note-2-weak-instrument">Cautionary note 2: weak instrument<a class="anchor" aria-label="anchor" href="#cautionary-note-2-weak-instrument"></a>
</h2>
<p>Weak instrument refers to an instrument that has a small impact on
the treatment. In the noncompliance setting, it means that the
assignment barely affects the treatment. In other words, there are many
never-takers and always-takers, but a very small proportion of
compliers.</p>
<p>A weak instrument, or a small proportion of compliers, could
theoretically plague the analysis and the decision-making by</p>
<ul>
<li>Posing difficulty in modeling the strata membership due to
imbalanced groups sizes, thus the outcomes within each strata, and the
CACE.</li>
<li>Combined with a small sample size, there will be little information
contained in the data to update our knowledge about the outcomes among
compliers and the CACE, inducing sensitivity to the priors.</li>
<li>Unreliable point estimate and wider credible intervals of the
CACE</li>
<li>Targeting at a very small proportion of the population where the
impact of the treatment is measureable.</li>
</ul>
<p>We show an example of a weak instrument.</p>
<div class="section level3">
<h3 id="data-simulation-3">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation-3"></a>
</h3>
<p>We tweak the proportion of compliers in the data-generating process.
We increase the sample size from 200 to 1000 to isolate the issues due
to a weak instrument from a small sample size. The issues discovered
below shall be further exacerbated with a smaller sample size.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1997</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Covariates: X observed, U unobserved</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## True memberships of principal strata (1:c,2:nt,3:at): S-model depends only on U</span></span>
<span><span class="va">true.PS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">U1.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">U0.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">U</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">num.U1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U1.ind</span><span class="op">)</span></span>
<span><span class="va">num.U0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">U0.ind</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U1.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.06</span>, <span class="fl">0.7</span>, <span class="fl">0.24</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">true.PS</span><span class="op">[</span><span class="va">U0.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="va">num.U0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.04</span>, <span class="fl">0.7</span>, <span class="fl">0.26</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment assigned: half control &amp; half treatment</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Treatment received: determined by principal strata and treatment assigned</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">c.trt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c.ctrl.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">nt.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">at.ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.PS</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">num.c.trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.trt.ind</span><span class="op">)</span></span>
<span><span class="va">num.c.ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">c.ctrl.ind</span><span class="op">)</span></span>
<span><span class="va">num.nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">nt.ind</span><span class="op">)</span></span>
<span><span class="va">num.at</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">at.ind</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.at</span><span class="op">)</span></span>
<span><span class="va">D</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">num.c.trt</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate observed outcome: Y-model depend on X, U, D, and principal strata</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.ctrl</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.ctrl.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.c.trt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">5250</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">c.trt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.nt</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">6000</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">nt.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">num.at</span>,</span>
<span>  mean <span class="op">=</span> <span class="fl">4500</span> <span class="op">+</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">X</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">U</span><span class="op">[</span><span class="va">at.ind</span><span class="op">]</span>,</span>
<span>  sd <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">Y</span>, Z <span class="op">=</span> <span class="va">Z</span>, D <span class="op">=</span> <span class="va">D</span>, X <span class="op">=</span> <span class="va">X</span>, U <span class="op">=</span> <span class="va">U</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fitting-a-biva-model-to-the-data-3">Fitting a BIVA model to the data<a class="anchor" aria-label="anchor" href="#fitting-a-biva-model-to-the-data-3"></a>
</h3>
<p>The prior specifications stay the same so we skip to the step of
fitting a BIVA model to the data.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/biva/man/biva-package.html" class="external-link">biva</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">df</span>, y <span class="op">=</span> <span class="st">"Y"</span>, d <span class="op">=</span> <span class="st">"D"</span>, z <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>  x_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  x_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>,</span>
<span>  ER <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  side <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  beta_mean_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_sd_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  beta_mean_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  beta_sd_smodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  sigma_shape_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  sigma_scale_ymodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  fit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 5e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.05 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 0.556 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                0.292 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                0.848 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 0.505 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                0.289 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                0.794 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 0.531 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                0.297 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                0.828 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 4e-06 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 0.553 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                0.293 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                0.846 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Fitting model to the data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.001052 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 10.52 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 107.675 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                13.473 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                121.148 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 2).</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Gradient evaluation took 0.000896 seconds</span></span>
<span><span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 8.96 seconds.</span></span>
<span><span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; Chain 2:  Elapsed Time: 97.963 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 2:                14.032 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 2:                111.995 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 2: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 3).</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Gradient evaluation took 0.000874 seconds</span></span>
<span><span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 8.74 seconds.</span></span>
<span><span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; Chain 3:  Elapsed Time: 89.396 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 3:                12.968 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 3:                102.364 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 3: </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'Gaussian' NOW (CHAIN 4).</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Gradient evaluation took 0.000901 seconds</span></span>
<span><span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 9.01 seconds.</span></span>
<span><span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4: </span></span>
<span><span class="co">#&gt; Chain 4:  Elapsed Time: 104.276 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 4:                14.178 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 4:                118.454 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 4:</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is 2.41, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span>
<span><span class="co">#&gt; Warning in initialize(...): Only 50% of the Rhats are less than 1.1Only 50% of</span></span>
<span><span class="co">#&gt; n_eff/N are greater than 0.001Only 50% of n_eff are greater than 100</span></span></code></pre></div>
<p>Inspecting the trace plot.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">tracePlot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Gaussian_files/figure-html/tracePlot_two_side_weak_IV-1.png" width="700" style="display: block; margin: auto;"></p>
<p>The four plots are the posterior draws of the mean outcomes among the
compliers assigned to control, the compliers nudged to treatment, the
never-takers, and the always-takers. The poor mixing is detected
again.</p>
<p>We run the weak IV test to see if there are any warnings.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ivobj</span><span class="op">$</span><span class="fu">weakIVTest</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; The instrument is considered weak, resulting in an estimated 6% of compliers in the population. Posterior point estimates of the CACE might be unreliable.</span></span></code></pre></div>
<p>The weak instrument issue is detected. It warned us about the
validity of the estimates if we were to interpret them or apply them to
the decision-making.</p>
<p>More detailed findings are reported by the same methods. Compared to
the results from the above two-side example with good mixing, it
overestimates the proportion of never-takers. Both posterior mean and
median are underestimated. More uncertainty is reflected in the
posterior probability that the CACE is greater than 200. Wider credible
intervals are reported.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Posterior distribution of the strata probability</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">strataProbEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 6% probability that the unit is a complier, a 68% probability that the unit is a never-taker, and a 26% probability that the unit is an always-taker.</span></span>
<span><span class="co"># Posterior probability that CACE is greater than 200</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">calcProb</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that the probability that the effect is more than 200 is 16%.</span></span>
<span><span class="co"># Posterior median of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -310.048</span></span>
<span><span class="co"># Posterior mean of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">pointEstimate</span><span class="op">(</span>median <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -250.5781</span></span>
<span><span class="co"># 75% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 75% probability that the CACE is between -601.61 and 222.41.</span></span>
<span><span class="co"># 95% credible interval of the CACE</span></span>
<span><span class="va">ivobj</span><span class="op">$</span><span class="fu">credibleInterval</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; Given the data, we estimate that there is a 95% probability that the CACE is between -640.02 and 286.69.</span></span></code></pre></div>
<p>The point estimates are way off. Compared with the summary findings
from the previous non-weak instrument case, the posterior probability is
shrinked and the credible intervals become wider, revealing more
uncertainty about the CACE. All these findings indicate that the weak
instrument issue is a serious concern, and the results should be
interpreted with caution instead of relying too much on the point
estimates.</p>
<p>A weak instrument issue can be best avoided by design. Powerful
encouragements to events or strong promotions of the features can
significantly help with circumventing the issue. Otherwise, it is better
to have a larger sample size to avoid the weak instrument issue being
further compounded by a small sample size.</p>
<hr>
<div class="section level4">
<h4 id="biva">BIVA<a class="anchor" aria-label="anchor" href="#biva"></a>
</h4>
<p>Licensed under the Apache License, Version 2.0.<br></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yichi Zhang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
